<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STORY Messenger PRO (Verified)</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root { --viber: #7360f2; --bg: #f0f2f5; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); overflow: hidden; }
        .hidden { display: none !important; }
        input, button, select, textarea { border-radius: 20px; border: 1px solid #ddd; padding: 12px; margin: 5px 0; width: 100%; box-sizing: border-box; outline: none; }
        header { background: var(--viber); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .page { height: calc(100vh - 125px); overflow-y: auto; padding-bottom: 70px; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; height: 65px; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; color: #666; }
        .nav-item.active { color: var(--viber); font-weight: bold; }
        .card { background: white; padding: 15px; margin: 10px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        #chat-win { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: flex; flex-direction: column; }
    </style>
</head>
<body>

<div id="auth-page">
    <header>STORY Messenger - Verify</header>
    <div style="padding: 20px;">
        <h2>‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±</h2>
        <p style="font-size: 13px; color: #666;">‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∑Ä‡∑í‡∂ß ‡∂ª‡∂ß‡∑ö ‡∂ö‡∑ö‡∂≠‡∂∫ ‡∑É‡∑Ñ‡∑í‡∂≠‡∑Ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (‡∂ã‡∂Ø‡∑è: +94771234567)</p>
        
        <div id="phone-input-sec">
            <input id="auth-phone" type="tel" placeholder="+94 7x xxx xxxx">
            <div id="recaptcha-container"></div>
            <button onclick="sendOTP()" style="background: var(--viber); color:white;">SMS ‡∂ö‡∑ö‡∂≠‡∂∫ ‡∂ë‡∑Ä‡∂±‡∑ä‡∂±</button>
        </div>

        <div id="otp-input-sec" class="hidden">
            <input id="auth-otp" type="number" placeholder="SMS ‡∂ö‡∑ö‡∂≠‡∂∫ (OTP) ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±">
            <input id="auth-user" placeholder="‡∂î‡∂∂‡∑ö ‡∂±‡∂∏ (‡∂¥‡∑Ö‡∂∏‡∑î ‡∑Ä‡∂ª‡∂ß ‡∂±‡∂∏‡∑ä)">
            <button onclick="verifyOTP()" style="background: #28a745; color:white;">‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª ‡∂á‡∂≠‡∑î‡∑Ö‡∑î ‡∑Ä‡∂±‡∑ä‡∂±</button>
        </div>
    </div>
</div>

<div id="main-app" class="hidden">
    <header>
        <span id="display-name">STORY</span>
        <button onclick="logout()" style="width:auto; padding:5px 10px; font-size:11px; background:rgba(255,255,255,0.2); border:none; color:white;">Logout</button>
    </header>

    <div id="page-chats" class="page">
        <div style="padding: 10px; display: flex;">
            <input id="search-phone" placeholder="‡∂Ö‡∂Ç‡∂ö‡∂∫ (+947...)">
            <button onclick="sendFriendRequest()" style="width:auto; margin-left:5px; background:var(--viber); color:white;">Invite</button>
        </div>
        <div id="requests-list"></div>
        <hr>
        <div id="contacts-list"></div>
    </div>

    <div id="page-stories" class="page hidden">
        <div style="padding: 15px;"><button onclick="openStoryModal()" style="background: var(--viber); color:white;">+ ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ø‡∑è‡∂±‡∑ä‡∂±</button></div>
        <div id="story-feed"></div>
    </div>

    <div id="chat-win" class="hidden">
        <header><span onclick="closeChat()">‚¨Ö Back</span><span id="chat-target">User</span><span></span></header>
        <div id="msg-container" style="flex:1; overflow-y:auto; padding:15px; background:#e5ddd5; display:flex; flex-direction:column;"></div>
        <div style="padding:10px; display:flex; background:white;"><input id="m-in" placeholder="Type..." style="margin:0;"><button onclick="sendMsg()" style="width:60px; background:var(--viber); color:white;">‚ûî</button></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="showPage('page-chats', this)">üí¨ Chats</div>
        <div class="nav-item" onclick="showPage('page-stories', this)">üìñ Stories</div>
    </div>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyDJ-9NkKH2GCkkLTr6Xr1Y7rz_bj3qJdF0", 
        databaseURL: "https://story-ceca0-default-rtdb.firebaseio.com", 
        projectId: "story-ceca0",
        authDomain: "story-ceca0.firebaseapp.com" // OTP ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂∏‡∑ô‡∂∫ ‡∂Ö‡∂≠‡∑ä‚Äç‡∂∫‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫‡∂∫‡∑í
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let confirmationResult;
    let myPhone = localStorage.getItem("phone") || "";
    let myName = localStorage.getItem("username") || "";

    if(myPhone && myName) startApp();

    // --- OTP Logic ---
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' });

    function sendOTP() {
        const phone = document.getElementById('auth-phone').value.trim();
        if(!phone.startsWith('+')) return alert("‡∂ª‡∂ß‡∑ö ‡∂ö‡∑ö‡∂≠‡∂∫ (+94) ‡∑É‡∑Ñ‡∑í‡∂≠‡∑Ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!");

        auth.signInWithPhoneNumber(phone, window.recaptchaVerifier)
            .then(res => {
                confirmationResult = res;
                document.getElementById('phone-input-sec').classList.add('hidden');
                document.getElementById('otp-input-sec').classList.remove('hidden');
                alert("‡∂î‡∂∂‡∑ö ‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂±‡∂∫‡∂ß ‡∂ö‡∑ö‡∂≠‡∂∫ ‡∂ë‡∑Ä‡∂±‡∑î ‡∂Ω‡∑ê‡∂∂‡∑î‡∑Ä‡∑è.");
            }).catch(err => alert("Error: " + err.message));
    }

    function verifyOTP() {
        const code = document.getElementById('auth-otp').value;
        const nameInput = document.getElementById('auth-user').value.trim();

        confirmationResult.confirm(code).then(result => {
            const user = result.user;
            myPhone = user.phoneNumber;
            
            // Database ‡∂ë‡∂ö‡∑ö ‡∂±‡∂∏ ‡∂≠‡∑í‡∂∂‡∑ö‡∂Ø‡∑ê‡∂∫‡∑í ‡∂∂‡∂Ω‡∂∏‡∑î
            db.ref('users/' + myPhone).once('value', s => {
                if(s.exists()) {
                    myName = s.val().name;
                } else {
                    if(!nameInput) return alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂î‡∂∂‡∑ö ‡∂±‡∂∏ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!");
                    myName = nameInput;
                    db.ref('users/' + myPhone).set({ name: myName });
                }
                localStorage.setItem("phone", myPhone);
                localStorage.setItem("username", myName);
                startApp();
            });
        }).catch(err => alert("‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂ö‡∑ö‡∂≠‡∂∫‡∂ö‡∑ä!"));
    }

    function startApp() {
        document.getElementById('auth-page').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('display-name').innerText = myName;
        loadRequests(); loadContacts(); loadAllStories();
    }

    // --- Friend & Chat Logic (‡∂ö‡∂Ω‡∑í‡∂±‡∑ä ‡∂≠‡∑í‡∂∂‡∑ñ ‡∂í‡∑Ä‡∑è ‡∂ë‡∂Ω‡∑ô‡∑É‡∂∏...) ---
    function sendFriendRequest() {
        const p = document.getElementById('search-phone').value.trim();
        if(p === myPhone) return;
        db.ref('users/'+p).once('value', s => {
            if(s.exists()) {
                db.ref(`requests/${p}/${myPhone}`).set({ name: myName, from: myPhone });
                alert("Request ‡∂ë‡∂ö ‡∂∫‡∑ê‡∑Ä‡∑ä‡∑Ä‡∑è!");
            } else alert("Verified STORY ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ö‡∑ä ‡∂±‡∑ê‡∂≠!");
        });
    }

    function loadRequests() {
        db.ref('requests/'+myPhone).on('value', s => {
            const div = document.getElementById('requests-list'); div.innerHTML = "";
            s.forEach(req => {
                const d = req.val();
                div.innerHTML += `<div class="card" style="background:#fff3cd">Invite: <b>${d.name}</b> <button onclick="acceptFriend('${d.from}','${d.name}')">Accept</button></div>`;
            });
        });
    }

    function acceptFriend(fP, fN) {
        db.ref(`contacts/${myPhone}/${fP}`).set({ name: fN, phone: fP });
        db.ref(`contacts/${fP}/${myPhone}`).set({ name: myName, phone: myPhone });
        db.ref(`requests/${myPhone}/${fP}`).remove();
    }

    function loadContacts() {
        db.ref('contacts/'+myPhone).on('value', s => {
            const list = document.getElementById('contacts-list'); list.innerHTML = "";
            s.forEach(c => {
                list.innerHTML += `<div class="card" onclick="openChat('${c.val().phone}','${c.val().name}')">üë§ ${c.val().name}</div>`;
            });
        });
    }

    let currentChatID = "";
    function openChat(p, n) {
        document.getElementById('chat-target').innerText = n;
        document.getElementById('chat-win').classList.remove('hidden');
        currentChatID = myPhone < p ? myPhone+"_"+p : p+"_"+myPhone;
        db.ref('chats/'+currentChatID).on('value', s => {
            const b = document.getElementById('msg-container'); b.innerHTML = "";
            s.forEach(m => {
                const isMe = m.val().s == myPhone;
                b.innerHTML += `<div style="align-self:${isMe?'flex-end':'flex-start'}; background:${isMe?'#dcf8c6':'white'}; padding:10px; border-radius:10px; margin-bottom:5px;">${m.val().t}</div>`;
            });
            b.scrollTop = b.scrollHeight;
        });
    }

    function sendMsg() {
        const t = document.getElementById('m-in').value;
        if(t) db.ref('chats/'+currentChatID).push({s: myPhone, t: t});
        document.getElementById('m-in').value = "";
    }

    function logout() { localStorage.clear(); location.reload(); }
    function showPage(id, el) { 
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden')); 
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }
    function closeChat() { document.getElementById('chat-win').classList.add('hidden'); }
    function openStoryModal() { alert("Stories ‡∑Ä‡∑ê‡∂© ‡∂ö‡∂ª‡∂∫‡∑í (‡∂ö‡∂Ω‡∑í‡∂±‡∑ä ‡∂ö‡∑ö‡∂≠‡∂∫ ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±)"); }
</script>
</body>
</html>
