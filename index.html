<div id="page-chats" class="page">
    <div style="padding: 10px; background: white; border-bottom: 1px solid #eee; display: flex;">
        <input id="add-phone" placeholder="අංකය ඇතුළත් කරන්න (07xxxxxxxx)" style="margin:0; flex:1;">
        <button onclick="addContact()" style="width:auto; margin:0 0 0 5px; background:var(--viber); color:white; border:none; padding:10px;">Add</button>
    </div>
    <div id="contacts-list">
        </div>
</div>

<script>
    // 1. Contact එකක් සේව් කිරීමේ Function එක
    function addContact() {
        const phone = document.getElementById('add-phone').value.trim();
        if(!phone) return;

        // මුලින්ම ඒ නම්බර් එකෙන් කෙනෙක් Register වෙලා ඉන්නවද බලනවා
        db.ref('users/' + phone).once('value', s => {
            if(s.exists()) {
                // අපේ Contact list එකට සේව් කරනවා
                db.ref('contacts/' + myPhone + '/' + phone).set({
                    name: s.val().name,
                    phone: phone
                }).then(() => {
                    alert(s.val().name + " එකතු කරගත්තා!");
                    document.getElementById('add-phone').value = "";
                });
            } else {
                alert("මෙම අංකයෙන් STORY ගිණුමක් නැත!");
            }
        });
    }

    // 2. හැමෝවම පෙන්වනවා වෙනුවට සේව් කරපු අය විතරක් පෙන්වීමට loadContacts වෙනස් කිරීම
    function loadContacts() {
        // දැන් බලන්නේ 'users' නෙමෙයි, 'contacts/මගේ_අංකය' යටතේ ඉන්න අය
        db.ref('contacts/' + myPhone).on('value', s => {
            const list = document.getElementById('contacts-list');
            list.innerHTML = "";
            if(!s.exists()) {
                list.innerHTML = "<p style='text-align:center; color:#999; margin-top:20px;'>තවම කොන්ටැක්ට් එකතු කර නැත.</p>";
                return;
            }
            s.forEach(c => {
                const u = c.val();
                list.innerHTML += `<div class="contact-card" onclick="openChat('${u.phone}', '${u.name}')">
                    <div style="width:40px; height:40px; border-radius:50%; background:#7360f2; color:white; margin-right:10px; display:flex; align-items:center; justify-content:center;">${u.name[0]}</div>
                    <b>${u.name}</b>
                </div>`;
            });
        });
    }
</script>
