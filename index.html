<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STORY Messenger PRO + Photos</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <style>
        :root { --viber: #7360f2; --bg: #f0f2f5; }
        body { font-family: sans-serif; margin: 0; background: var(--bg); overflow: hidden; }
        .hidden { display: none !important; }
        input, button, select, textarea { border-radius: 20px; border: 1px solid #ddd; padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; outline: none; }
        header { background: var(--viber); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .page { height: calc(100vh - 125px); overflow-y: auto; padding-bottom: 70px; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #eee; height: 65px; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; color: #666; }
        .nav-item.active { color: var(--viber); font-weight: bold; }
        
        /* Profiles & Stories */
        .profile-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; background: #ddd; }
        .story-img { width: 100%; border-radius: 10px; margin-top: 10px; max-height: 300px; object-fit: cover; }
        .card { background: white; padding: 15px; margin: 10px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        #chat-win { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: flex; flex-direction: column; }
        .modal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:200; padding:20px; box-sizing:border-box; color:white; overflow-y:auto; }
    </style>
</head>
<body>

<audio id="notif-alert" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>

<div id="auth-page">
    <header>STORY Messenger</header>
    <div style="padding: 20px;">
        <h2 id="auth-title">Login</h2>
        <input id="auth-phone" type="tel" placeholder="Phone Number">
        <input id="auth-pass" type="password" placeholder="Password">
        <div id="username-div" class="hidden">
            <input id="auth-user" placeholder="Username">
            <p style="font-size:12px;">Profile ‡∂¥‡∑í‡∂±‡∑ä‡∂≠‡∑ñ‡∂ª‡∂∫‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±:</p>
            <input type="file" id="profile-upload" accept="image/*">
        </div>
        <button onclick="handleAuth()" style="background: var(--viber); color:white;">Continue</button>
        <p id="toggle-text" onclick="toggleAuthMode()" style="text-align:center; color: var(--viber); cursor:pointer;">‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ö‡∑ä ‡∑É‡∑è‡∂Ø‡∂±‡∑ä‡∂±</p>
    </div>
</div>

<div id="main-app" class="hidden">
    <header>
        <div style="display:flex; align-items:center;">
            <img id="my-pfp" class="profile-img" src="">
            <span id="display-name">STORY</span>
        </div>
        <button onclick="logout()" style="width:auto; padding:5px; font-size:11px; background:rgba(255,255,255,0.2); border:none; color:white;">Logout</button>
    </header>

    <div id="page-chats" class="page">
        <div style="padding: 10px; display: flex;">
            <input id="search-phone" placeholder="‡∂∏‡∑í‡∂≠‡∑î‡∂ª‡∑ô‡∂ö‡∑î ‡∑É‡∑ú‡∂∫‡∂±‡∑ä‡∂±...">
            <button onclick="sendFriendRequest()" style="width:auto; margin-left:5px; background:var(--viber); color:white;">Invite</button>
        </div>
        <div id="requests-list"></div>
        <div id="contacts-list"></div>
    </div>

    <div id="page-stories" class="page hidden">
        <div style="padding: 15px;"><button onclick="openStoryModal()" style="background: var(--viber); color:white;">+ ‡∂¥‡∑ù‡∑É‡∑ä‡∂ß‡∑ä ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂Ø‡∑è‡∂±‡∑ä‡∂±</button></div>
        <div id="story-feed"></div>
    </div>

    <div id="story-modal" class="modal hidden">
        <span onclick="closeStoryModal()" style="float:right; font-size:30px; cursor:pointer;">√ó</span>
        <h3>New Story</h3>
        <textarea id="story-input" placeholder="‡∂î‡∂∫‡∑è‡∂ú‡∑ö ‡∂ö‡∂≠‡∑è‡∑Ä..."></textarea>
        <p style="font-size:12px;">‡∂¥‡∑í‡∂±‡∑ä‡∂≠‡∑ñ‡∂ª‡∂∫‡∂ö‡∑ä ‡∂ë‡∂ö‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂± (Optional):</p>
        <input type="file" id="story-upload" accept="image/*">
        <button id="post-btn" onclick="postStory()" style="background:var(--viber); color:white;">Post Now</button>
    </div>

    <div id="chat-win" class="hidden">
        <header><span onclick="closeChat()">‚¨Ö Back</span><span id="chat-target">User</span><span></span></header>
        <div id="msg-container" style="flex:1; overflow-y:auto; padding:15px; background:#e5ddd5; display:flex; flex-direction:column;"></div>
        <div style="padding:10px; display:flex; background:white;"><input id="m-in" placeholder="Type..." style="margin:0;"><button onclick="sendMsg()" style="width:60px; background:var(--viber); color:white;">‚ûî</button></div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="showPage('page-chats', this)">üí¨ Chats</div>
        <div class="nav-item" onclick="showPage('page-stories', this)">üìñ Stories</div>
    </div>
</div>

<script>
    const firebaseConfig = { 
        apiKey: "AIzaSyDJ-9NkKH2GCkkLTr6Xr1Y7rz_bj3qJdF0", 
        databaseURL: "https://story-ceca0-default-rtdb.firebaseio.com", 
        projectId: "story-ceca0",
        storageBucket: "story-ceca0.appspot.com"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    let myPhone = localStorage.getItem("phone") || "";
    let myName = localStorage.getItem("username") || "";
    let myPic = localStorage.getItem("pfp") || "";
    let isSignupMode = false;

    if(myPhone && myName) startApp();

    function toggleAuthMode() {
        isSignupMode = !isSignupMode;
        document.getElementById('auth-title').innerText = isSignupMode ? "Sign Up" : "Login";
        document.getElementById('username-div').classList.toggle('hidden', !isSignupMode);
    }

    async function handleAuth() {
        const phone = document.getElementById('auth-phone').value.trim();
        const pass = document.getElementById('auth-pass').value;
        const user = document.getElementById('auth-user').value.trim();
        const file = document.getElementById('profile-upload').files[0];

        if(isSignupMode) {
            let purl = "";
            if(file) {
                const sRef = storage.ref('profiles/'+phone);
                await sRef.put(file);
                purl = await sRef.getDownloadURL();
            }
            db.ref('users/'+phone).set({pass, name: user, pfp: purl}).then(() => { alert("Done! Now Login."); toggleAuthMode(); });
        } else {
            db.ref('users/'+phone).once('value', s => {
                if(s.exists() && s.val().pass == pass) {
                    myPhone = phone; myName = s.val().name; myPic = s.val().pfp || "";
                    localStorage.setItem("phone", phone); localStorage.setItem("username", myName); localStorage.setItem("pfp", myPic);
                    startApp();
                } else alert("‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í!");
            });
        }
    }

    function startApp() {
        document.getElementById('auth-page').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        document.getElementById('display-name').innerText = myName;
        document.getElementById('my-pfp').src = myPic || "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        loadRequests(); loadContacts(); loadAllStories();
    }

    // --- Image Story Logic ---
    async function postStory() {
        const btn = document.getElementById('post-btn');
        const txt = document.getElementById('story-input').value;
        const file = document.getElementById('story-upload').files[0];
        if(!txt && !file) return;

        btn.disabled = true; btn.innerText = "Uploading...";
        let imgUrl = "";
        
        if(file) {
            const sRef = storage.ref('stories/' + Date.now());
            await sRef.put(file);
            imgUrl = await sRef.getDownloadURL();
        }

        db.ref('stories').push({
            phone: myPhone, user: myName, pfp: myPic, 
            text: txt, img: imgUrl, time: new Date().toLocaleString()
        });

        btn.disabled = false; btn.innerText = "Post Now";
        closeStoryModal();
    }

    function loadAllStories() {
        db.ref('stories').on('value', s => {
            const feed = document.getElementById('story-feed'); feed.innerHTML = "";
            s.forEach(st => {
                const d = st.val();
                feed.insertAdjacentHTML('afterbegin', `
                    <div class="card">
                        <div style="display:flex; align-items:center; margin-bottom:10px;">
                            <img class="profile-img" src="${d.pfp || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}">
                            <b>${d.user}</b>
                        </div>
                        <div style="font-size:15px;">${d.text}</div>
                        ${d.img ? `<img src="${d.img}" class="story-img">` : ''}
                        <div style="font-size:11px; color:#888; margin-top:10px;">${d.time}</div>
                    </div>
                `);
            });
        });
    }

    // --- Contacts & Chat ---
    function sendFriendRequest() {
        const p = document.getElementById('search-phone').value.trim();
        db.ref('users/'+p).once('value', s => {
            if(s.exists()) db.ref(`requests/${p}/${myPhone}`).set({ name: myName, from: myPhone, pfp: myPic });
        });
    }

    function loadRequests() {
        db.ref('requests/'+myPhone).on('value', s => {
            const div = document.getElementById('requests-list'); div.innerHTML = "";
            s.forEach(req => {
                const d = req.val();
                div.innerHTML += `<div class="card" style="background:#fff3cd">Invite: <b>${d.name}</b> <button onclick="acceptFriend('${d.from}','${d.name}','${d.pfp}')">Accept</button></div>`;
            });
        });
    }

    function acceptFriend(fP, fN, fPic) {
        db.ref(`contacts/${myPhone}/${fP}`).set({ name: fN, phone: fP, pfp: fPic });
        db.ref(`contacts/${fP}/${myPhone}`).set({ name: myName, phone: myPhone, pfp: myPic });
        db.ref(`requests/${myPhone}/${fP}`).remove();
    }

    function loadContacts() {
        db.ref('contacts/'+myPhone).on('value', s => {
            const list = document.getElementById('contacts-list'); list.innerHTML = "";
            s.forEach(c => {
                const d = c.val();
                list.innerHTML += `<div class="card" style="display:flex; align-items:center;" onclick="openChat('${d.phone}','${d.name}')">
                    <img src="${d.pfp || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="profile-img">
                    <b>${d.name}</b>
                </div>`;
            });
        });
    }

    function openChat(p, n) {
        document.getElementById('chat-target').innerText = n;
        document.getElementById('chat-win').classList.remove('hidden');
        const cid = myPhone < p ? myPhone+"_"+p : p+"_"+myPhone;
        db.ref('chats/'+cid).on('value', s => {
            const b = document.getElementById('msg-container'); b.innerHTML = "";
            s.forEach(m => {
                const isMe = m.val().s == myPhone;
                b.innerHTML += `<div style="align-self:${isMe?'flex-end':'flex-start'}; background:${isMe?'#dcf8c6':'white'}; padding:10px; border-radius:10px; margin-bottom:5px;">${m.val().t}</div>`;
            });
            b.scrollTop = b.scrollHeight;
        });
        window.currentCID = cid;
    }

    function sendMsg() {
        const t = document.getElementById('m-in').value;
        if(t) db.ref('chats/'+window.currentCID).push({s: myPhone, t: t});
        document.getElementById('m-in').value = "";
    }

    function logout() { localStorage.clear(); location.reload(); }
    function showPage(id, el) { 
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden')); 
        document.getElementById(id).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    }
    function closeChat() { document.getElementById('chat-win').classList.add('hidden'); }
    function openStoryModal() { document.getElementById('story-modal').classList.remove('hidden'); }
    function closeStoryModal() { 
        document.getElementById('story-modal').classList.add('hidden'); 
        document.getElementById('story-input').value = "";
        document.getElementById('story-upload').value = "";
    }
</script>
</body>
</html>
