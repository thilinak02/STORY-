<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STORY Messenger v2</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --wa-green: #25D366; --wa-dark: #075E54; }
        body { font-family: sans-serif; margin: 0; background: #f0f2f5; }
        .container { max-width: 400px; margin: auto; height: 100vh; display: flex; flex-direction: column; background: white; }
        .hidden { display: none; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 20px; border: 1px solid #ddd; box-sizing: border-box; }
        .btn-main { background: var(--wa-green); color: white; font-weight: bold; border: none; cursor: pointer; }
        header { background: var(--wa-dark); color: white; padding: 15px; text-align: center; }
        #chat-box { flex: 1; overflow-y: auto; padding: 15px; background: #e5ddd5; }
        .msg { padding: 8px 12px; border-radius: 10px; margin-bottom: 5px; max-width: 70%; word-wrap: break-word; }
        .sent { background: #dcf8c6; align-self: flex-end; margin-left: auto; }
        .rec { background: white; align-self: flex-start; }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-screen" style="padding: 20px;">
        <h2 style="text-align:center; color: var(--wa-dark);">STORY Messenger</h2>
        <div id="login-form">
            <h3>ඇතුළු වන්න (Login)</h3>
            <input type="text" id="log-user" placeholder="Username">
            <input type="password" id="log-pass" placeholder="Password">
            <button class="btn-main" onclick="login()">Login</button>
            <p onclick="toggleAuth()" style="text-align:center; cursor:pointer; color:blue;">අලුත් ගිණුමක් හදන්න (Sign Up)</p>
        </div>
        <div id="signup-form" class="hidden">
            <h3>ගිණුමක් හදන්න (Sign Up)</h3>
            <input type="text" id="sign-user" placeholder="Choose Username">
            <input type="password" id="sign-pass" placeholder="Create Password">
            <input type="text" id="sign-img" placeholder="Profile Photo URL (Link)">
            <button class="btn-main" onclick="signup()">Sign Up</button>
            <p onclick="toggleAuth()" style="text-align:center; cursor:pointer; color:blue;">දැනටමත් ගිණුමක් තිබේ නම් (Login)</p>
        </div>
    </div>

    <div id="chat-screen" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
        <header id="chat-header">STORY Chat</header>
        <div id="chat-box"></div>
        <div style="padding: 10px; display: flex; gap: 5px;">
            <input type="text" id="msgInput" placeholder="Type a message..." style="margin: 0;">
            <button onclick="sendMsg()" style="width: 60px; margin: 0; background: var(--wa-green); color: white; border: none; border-radius: 50%;">➔</button>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDJ-9NkKH2GCkkLTr6Xr1Y7rz_bj3qJdF0",
        databaseURL: "https://story-ceca0-default-rtdb.firebaseio.com",
        projectId: "story-ceca0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentUser = null;

    function toggleAuth() {
        document.getElementById('login-form').classList.toggle('hidden');
        document.getElementById('signup-form').classList.toggle('hidden');
    }

    function signup() {
        const u = document.getElementById('sign-user').value;
        const p = document.getElementById('sign-pass').value;
        const img = document.getElementById('sign-img').value;
        if(!u || !p) return alert("කරුණාකර සියල්ල පුරවන්න!");

        db.ref('users/' + u).set({ password: p, photo: img }, (err) => {
            if(!err) { alert("ගිණුම සාර්ථකව හැදුවා! දැන් Login වන්න."); toggleAuth(); }
        });
    }

    function login() {
        const u = document.getElementById('log-user').value;
        const p = document.getElementById('log-pass').value;

        db.ref('users/' + u).once('value', snap => {
            if(snap.exists() && snap.val().password === p) {
                currentUser = u;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('chat-screen').classList.remove('hidden');
                document.getElementById('chat-header').innerText = "Logged in as: " + u;
                loadMessages();
            } else {
                alert("Username හෝ Password වැරදියි!");
            }
        });
    }

    function sendMsg() {
        const txt = document.getElementById('msgInput').value;
        if(!txt || !currentUser) return;
        db.ref('global_chat').push({ user: currentUser, text: txt, time: Date.now() });
        document.getElementById('msgInput').value = "";
    }

    function loadMessages() {
        db.ref('global_chat').on('value', snap => {
            const box = document.getElementById('chat-box');
            box.innerHTML = "";
            snap.forEach(m => {
                const d = m.val();
                const cls = d.user === currentUser ? 'sent' : 'rec';
                box.innerHTML += `<div class="msg ${cls}"><b>${d.user}:</b><br>${d.text}</div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    }
</script>
</body>
</html>
