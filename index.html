<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STORY Messenger PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --viber: #7360f2; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); }
        .screen { display: none; height: 100vh; flex-direction: column; }
        .active { display: flex; }
        
        /* Login Card */
        .login-box { background: white; padding: 40px 20px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 85%; max-width: 400px; margin: auto; text-align: center; }
        .v-btn { background: var(--viber); color: white; border: none; padding: 15px; width: 100%; border-radius: 30px; font-weight: bold; font-size: 16px; margin-top: 20px; cursor: pointer; }
        
        /* Header */
        header { background: var(--viber); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 20px; }
        
        /* User List */
        .user-card { background: white; margin: 10px; padding: 15px; border-radius: 15px; display: flex; align-items: center; gap: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .profile-pic { width: 50px; height: 50px; background: #ddd; border-radius: 50%; overflow: hidden; }
        .profile-pic img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Stickers Footer */
        .sticker-bar { background: white; padding: 10px; display: flex; justify-content: space-around; border-top: 1px solid #ddd; position: fixed; bottom: 0; width: 100%; }
        .stk { font-size: 30px; cursor: pointer; transition: 0.2s; }
        .stk:hover { transform: scale(1.2); }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <div class="login-box">
            <h1 style="color:var(--viber); margin-bottom:10px;">STORY</h1>
            <p style="color:#666;">‡∂±‡∑í‡∂∫‡∂∏ Messenger ‡∂Ö‡∂≠‡∑ä‡∂Ø‡∑ê‡∂ö‡∑ì‡∂∏</p>
            <input type="tel" id="phone" style="width:100%;">
            <div id="recaptcha-container" style="margin-top:15px;"></div>
            <button class="v-btn" id="send-btn" onclick="sendOTP()">SMS ‡∂ë‡∑Ä‡∂±‡∑ä‡∂±</button>
        </div>
    </div>

    <div id="main-screen" class="screen">
        <header>
            <span>STORY</span>
            <div style="font-size:12px; opacity:0.8;" id="my-num"></div>
        </header>
        
        <div id="user-list" style="flex:1; overflow-y:auto; padding-bottom: 80px;">
            <p style="text-align:center; color:#888; margin-top:20px;">‡∑É‡∂ö‡∑ä‚Äç‡∂ª‡∑ì‡∂∫ ‡∂¥‡∂ª‡∑í‡∑Å‡∑ì‡∂Ω‡∂ö‡∂∫‡∂±‡∑ä ‡∑É‡∑ú‡∂∫‡∂∏‡∑í‡∂±‡∑ä...</p>
        </div>

        <div class="sticker-bar">
            <span class="stk" onclick="sendSticker('‚ù§Ô∏è')">‚ù§Ô∏è</span>
            <span class="stk" onclick="sendSticker('üòÇ')">üòÇ</span>
            <span class="stk" onclick="sendSticker('üî•')">üî•</span>
            <span class="stk" onclick="sendSticker('üëã')">üëã</span>
            <span class="stk" onclick="invite()">‚ûï</span>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDJ-9NkKH2GCkkLTr6Xr1Y7rz_bj3qJdF0",
            authDomain: "story-ceca0.firebaseapp.com",
            projectId: "story-ceca0",
            storageBucket: "story-ceca0.firebasestorage.app",
            messagingSenderId: "820075788039",
            appId: "1:820075788039:web:076857bff62a48759a77a2",
            databaseURL: "https://story-ceca0-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);

        const input = document.querySelector("#phone");
        const iti = window.intlTelInput(input, { initialCountry: "lk", separateDialCode: true });

        // reCAPTCHA ‡∂ë‡∂ö ‡∂¥‡∑è‡∂ª‡∂ö‡∑ä ‡∂¥‡∂∏‡∂´‡∂ö‡∑ä ‡∑É‡∑ô‡∂ß‡∑ä ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' });

        function sendOTP() {
            const num = iti.getNumber();
            if(!num) return alert("‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±");

            firebase.auth().signInWithPhoneNumber(num, window.recaptchaVerifier)
                .then(res => {
                    window.confirmationResult = res;
                    const otp = prompt("‡∂î‡∂∂‡∑ö ‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂±‡∂∫‡∂ß ‡∂Ü ‡∂Ö‡∂Ç‡∂ö 6 ‡∂∏‡∑ô‡∂≠‡∂± ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±:");
                    if(otp) {
                        res.confirm(otp).then(userRes => {
                            loginSuccess(userRes.user.phoneNumber);
                        }).catch(() => alert("‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í OTP ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑ä!"));
                    }
                }).catch(err => alert("‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä: " + err.message));
        }

        function loginSuccess(number) {
            document.getElementById('my-num').innerText = number;
            firebase.database().ref("users/" + number.replace('+', '')).set({
                status: "online",
                lastSeen: Date.now()
            });
            document.getElementById('login-screen').classList.remove('active');
            document.getElementById('main-screen').classList.add('active');
            loadUsers();
        }

        function loadUsers() {
            firebase.database().ref("users").on("value", snap => {
                const list = document.getElementById('user-list');
                list.innerHTML = "";
                snap.forEach(child => {
                    list.innerHTML += `
                        <div class="user-card">
                            <div class="profile-pic"><img src="https://ui-avatars.com/api/?name=${child.key}&background=random"></div>
                            <div style="flex:1">
                                <strong>+${child.key}</strong><br>
                                <small style="color:green">Online</small>
                            </div>
                            <button style="border:none; background:none; color:var(--viber); font-weight:bold;">CHAT</button>
                        </div>`;
                });
            });
        }

        function sendSticker(s) {
            alert("STORY Sticker ‡∂∫‡∑ê‡∑Ä‡∑ä‡∑Ä‡∑è: " + s);
        }

        function invite() {
            const n = prompt("Invite ‡∂ö‡∂ª‡∂±‡∑ä‡∂± ‡∂Ö‡∑Ä‡∑Å‡∑ä‚Äç‡∂∫ ‡∂±‡∂∏‡∑ä‡∂∂‡∂ª‡∑ä ‡∂ë‡∂ö (+94...):");
            if(n) window.open(`https://wa.me/${n.replace('+', '')}?text=Join me on STORY Messenger: ${window.location.href}`);
        }
    </script>
</body>
</html>
